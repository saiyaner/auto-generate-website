server {
    listen 8081;
    server_name ~^(?<subdomain>.+)\.citaks\.my\.id$;

    # Log files for debugging
    access_log /var/log/nginx/tunnel-proxy-access.log;
    error_log /var/log/nginx/tunnel-proxy-error.log;

    location / {
        # Default fallback if subdomain not found
        set $target_port 0;

        # Read port mapping using Lua (requires nginx-mod-http-lua)
        # Alternatively, we'll use a simpler map-based approach below
        
        # Include mapping file
        include /var/www/auto-gen/nginx/proxy_map.conf;

        # Check if mapping exists
        if ($target_port = 0) {
            return 404 "Site not found";
        }

        # Proxy to the specific container port
        proxy_pass http://localhost:$target_port;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
